from flask import Flask, request, jsonify
from flask_pymongo import PyMongo
from bson.objectid import ObjectId
from flask_cors import CORS
import os

app = Flask(__name__)
CORS(app)

# Cấu hình MongoDB (dùng local mặc định, có thể thay bằng MongoDB Atlas)
app.config["MONGO_URI"] = os.getenv("MONGO_URI", "mongodb://localhost:27017/todolist")
mongo = PyMongo(app)

todos_collection = mongo.db.todos

# Lấy danh sách todo
@app.route('/todos', methods=['GET'])
def get_todos():
    todos = []
    for todo in todos_collection.find():
        todos.append({
            '_id': str(todo['_id']),
            'title': todo.get('title', ''),
            'description': todo.get('description', ''),
            'status': todo.get('status', False)
        })
    return jsonify(todos)

# Thêm todo mới
@app.route('/todos', methods=['POST'])
def add_todo():
    data = request.json
    title = data.get('title', '')
    description = data.get('description', '')
    status = data.get('status', False)
    todo_id = todos_collection.insert_one({
        'title': title,
        'description': description,
        'status': status
    }).inserted_id
    return jsonify({'_id': str(todo_id), 'title': title, 'description': description, 'status': status}), 201

# Sửa todo
@app.route('/todos/<todo_id>', methods=['PUT'])
def update_todo(todo_id):
    data = request.json
    update_data = {}
    if 'title' in data:
        update_data['title'] = data['title']
    if 'description' in data:
        update_data['description'] = data['description']
    if 'status' in data:
        update_data['status'] = data['status']
    result = todos_collection.update_one({'_id': ObjectId(todo_id)}, {'$set': update_data})
    if result.matched_count == 0:
        return jsonify({'error': 'Todo not found'}), 404
    return jsonify({'message': 'Todo updated'})

# Xóa todo
@app.route('/todos/<todo_id>', methods=['DELETE'])
def delete_todo(todo_id):
    result = todos_collection.delete_one({'_id': ObjectId(todo_id)})
    if result.deleted_count == 0:
        return jsonify({'error': 'Todo not found'}), 404
    return jsonify({'message': 'Todo deleted'})

if __name__ == '__main__':
    app.run(debug=True) 